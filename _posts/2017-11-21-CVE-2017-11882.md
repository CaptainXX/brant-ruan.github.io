---
title: CVE-2017-11882 实验 | Office内存破坏漏洞
category: Sec
---

## CVE-2017-11882 实验 | Office内存破坏漏洞

### 0x00 前述

最初是在360安全客的[这篇文章](http://bobao.360.cn/learning/detail/4729.html)中了解到这个漏洞，没有打算深入进去。今天看到安全客做的[漏洞分析](http://bobao.360.cn/learning/detail/4734.html)，感觉蛮有意思，就找到Github上的PoC，简单搭了个环境准备试一试。成功弹出了计算器，正好来学习一下Windows下的漏洞调试。

注：本文参照安全客的[文章](http://bobao.360.cn/learning/detail/4734.html)，记录自己的调试过程。感谢安全客。

### 0x01 环境搭建

```bat
%System Info%
msinfo32
```

得到系统信息如下：

![]({{ site.url }}/images/CVE-2017-11882/test0.png)

Office信息如下：

![]({{ site.url }}/images/CVE-2017-11882/test1.png)

### 0x02 PoC复现

从[这里](https://github.com/embedi/CVE-2017-11882)下载PoC，运行`example/exploit.rtf`，弹出计算器：

![]({{ site.url }}/images/CVE-2017-11882/test2.png)

### 0x03 漏洞调试

① 搜索C盘找到`EQNEDT.exe`

```
C:\Program Files\Common Files\Microsoft Shared\EQUATION\EQUATION32.exe
```

② 使用IDA Pro

找到`sub_41160F`函数，果然在`strcpy`时没有检查长度（在大量的函数中寻找可能的漏洞点，猜测漏洞发现者应该是使用`Fuzzing`或者对敏感函数批量搜索等方法找到的）：

![]({{ site.url }}/images/CVE-2017-11882/test3.png)

③ 使用Ollydbg跟到`sub_41160F`函数

`Ctrl + g`输入`0x41160f`，转到地址后`F4`执行到这里。根据函数参数压栈规则，第一个参数`a1`（使用IDA Pro中函数参数名，下同）最后被压栈。所以在进入`sub_41160F`时栈上返回地址再往上一个空间存储的即为`a1`参数，是一个指针，为`0018FAE0`。右键在数据窗口中转到这个地方，可以看到`宋体`字样。所以这个参数的含义应该是字体名。参照下图：

![]({{ site.url }}/images/CVE-2017-11882/test4.png)

未完待续。

### 0x04 参考

- [【技术分享】微软如何手工修复Office Equation内存破坏漏洞（CVE-2017-11882）](http://bobao.360.cn/learning/detail/4729.html)
- [【漏洞分析】Microsoft Office内存损坏漏洞（CVE–2017–11882)分析](http://bobao.360.cn/learning/detail/4734.html)
- [Github: embedi/CVE-2017-11882](https://github.com/embedi/CVE-2017-11882)